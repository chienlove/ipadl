<!doctype html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width,initial-scale=1,viewport-fit=cover"
    />
    <title>ThÃªm á»©ng dá»¥ng vÃ o â€œÄÃ£ muaâ€</title>
    <style>
      :root {
        color-scheme: light dark;
        --bg: #f3f4f6;
        --card-bg: #ffffff;
        --text: #111827;
        --muted: #6b7280;
        --border: #e5e7eb;
        --primary: #2563eb;
        --primary-dark: #1d4ed8;
        --danger: #dc2626;
        --success: #16a34a;
        --radius: 10px;
      }
      @media (prefers-color-scheme: dark) {
        :root {
          --bg: #020617;
          --card-bg: #020617;
          --text: #e5e7eb;
          --muted: #9ca3af;
          --border: #111827;
        }
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        display: flex;
        align-items: flex-start;
        justify-content: center;
        background: radial-gradient(circle at top, #0f172a, #020617 60%);
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI',
          Roboto, sans-serif;
        color: var(--text);
        padding: 24px 12px;
      }

      .card {
        width: 100%;
        max-width: 720px;
        background: var(--card-bg);
        border-radius: 20px;
        border: 1px solid rgba(148, 163, 184, 0.3);
        box-shadow: 0 20px 40px rgba(15, 23, 42, 0.45);
        padding: 20px 18px 18px;
      }

      @media (min-width: 640px) {
        .card {
          padding: 24px 24px 20px;
        }
      }

      h1 {
        font-size: 20px;
        margin: 0 0 4px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      h1 span.emoji {
        font-size: 24px;
      }

      .subtitle {
        margin: 0 0 16px;
        font-size: 13px;
        color: var(--muted);
      }

      form {
        display: grid;
        gap: 10px;
        margin-top: 8px;
        margin-bottom: 14px;
      }

      label {
        font-size: 13px;
        font-weight: 600;
        margin-bottom: 4px;
        display: block;
      }

      .field {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      input,
      select {
        width: 100%;
        border-radius: 999px;
        border: 1px solid var(--border);
        padding: 8px 14px;
        font-size: 13px;
        background: rgba(15, 23, 42, 0.02);
        color: var(--text);
        outline: none;
        transition: border-color 0.15s ease, box-shadow 0.15s ease,
          background 0.15s ease;
      }

      input::placeholder {
        color: #9ca3af;
      }

      input:focus,
      select:focus {
        border-color: var(--primary);
        box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.35);
        background: rgba(15, 23, 42, 0.03);
      }

      .row {
        display: grid;
        grid-template-columns: 1.1fr 0.9fr;
        gap: 10px;
      }

      @media (max-width: 480px) {
        .row {
          grid-template-columns: 1fr;
        }
      }

      button[type='submit'] {
        border: none;
        border-radius: 999px;
        padding: 10px 16px;
        font-size: 14px;
        font-weight: 700;
        background: linear-gradient(135deg, #2563eb, #4f46e5);
        color: #f9fafb;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        transition: transform 0.12s ease, box-shadow 0.12s ease,
          filter 0.12s ease;
        box-shadow: 0 10px 18px rgba(37, 99, 235, 0.45);
      }

      button[type='submit']:hover {
        transform: translateY(-1px);
        filter: brightness(1.03);
        box-shadow: 0 14px 26px rgba(37, 99, 235, 0.55);
      }

      button[type='submit']:active {
        transform: translateY(0);
        box-shadow: 0 6px 12px rgba(15, 23, 42, 0.9);
      }

      button[type='submit']:disabled {
        opacity: 0.6;
        cursor: default;
        transform: none;
        box-shadow: none;
      }

      .btn-label {
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        border-radius: 999px;
        padding: 3px 8px;
        font-size: 11px;
        font-weight: 600;
        border: 1px solid rgba(148, 163, 184, 0.4);
        background: rgba(15, 23, 42, 0.02);
        color: var(--muted);
      }

      .status {
        border-radius: 12px;
        padding: 8px 10px;
        font-size: 12px;
        margin-bottom: 8px;
        display: none;
        align-items: center;
        gap: 8px;
      }

      .status--info {
        display: flex;
        background: rgba(59, 130, 246, 0.08);
        border: 1px solid rgba(59, 130, 246, 0.4);
        color: #1d4ed8;
      }

      .status--success {
        display: flex;
        background: rgba(22, 163, 74, 0.08);
        border: 1px solid rgba(22, 163, 74, 0.45);
        color: #15803d;
      }

      .status--error {
        display: flex;
        background: rgba(220, 38, 38, 0.08);
        border: 1px solid rgba(220, 38, 38, 0.4);
        color: #b91c1c;
      }

      .status-icon {
        font-size: 14px;
      }

      .status-text {
        flex: 1;
      }

      .status-code {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          'Liberation Mono', 'Courier New', monospace;
        font-size: 11px;
        opacity: 0.8;
      }

      .output-wrap {
        margin-top: 10px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: rgba(15, 23, 42, 0.02);
        padding: 8px;
      }

      #out {
        margin: 0;
        white-space: pre-wrap;
        word-break: break-word;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
          'Liberation Mono', 'Courier New', monospace;
        font-size: 11px;
        line-height: 1.5;
        max-height: 320px;
        overflow: auto;
      }

      .helper-text {
        font-size: 11px;
        color: var(--muted);
      }

      .storefront-inline {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }

      @media (min-width: 520px) {
        .storefront-inline {
          flex-direction: row;
          align-items: center;
        }
        .storefront-inline > * {
          flex: 1;
        }
      }
    </style>
  </head>
  <body>
    <main class="card">
      <header style="margin-bottom: 10px">
        <h1>
          <span class="emoji">â­</span>
          <span>ThÃªm á»©ng dá»¥ng vÃ o â€œÄÃ£ muaâ€</span>
          <span class="pill">
            <span>Admin only</span>
          </span>
        </h1>
        <p class="subtitle">
          DÃ¹ng cho <strong>app miá»…n phÃ­</strong>. Apple sáº½ ghi nháº­n app vÃ o Apple
          ID nhÆ° khi báº¡n báº¥m â€œNháº­n/Getâ€ trÃªn App Store.
        </p>
      </header>

      <form id="f">
        <div class="field">
          <label for="APPLE_ID">Apple ID (email)</label>
          <input
            id="APPLE_ID"
            placeholder="vÃ­ dá»¥: user@example.com"
            autocomplete="username"
            required
          />
        </div>

        <div class="field">
          <label for="PASSWORD">Máº­t kháº©u Apple ID</label>
          <input
            id="PASSWORD"
            placeholder="Nháº­p máº­t kháº©u"
            type="password"
            autocomplete="current-password"
            required
          />
        </div>

        <div class="row">
          <div class="field">
            <label for="CODE">MÃ£ 2FA (náº¿u cÃ³)</label>
            <input id="CODE" placeholder="CÃ³ thá»ƒ Ä‘á»ƒ trá»‘ng" />
          </div>
          <div class="field">
            <label for="STOREFRONT_SELECT">Storefront</label>
            <div class="storefront-inline">
              <select id="STOREFRONT_SELECT">
                <option value="">Tá»± Ä‘á»™ng (khuyÃªn dÃ¹ng)</option>
                <option value="143471-1,32"
                  >ğŸ‡»ğŸ‡³ Viá»‡t Nam (143471-1,32)</option
                >
                <option value="143441-1,32"
                  >ğŸ‡ºğŸ‡¸ United States (143441-1,32)</option
                >
                <option value="143462-1,32">ğŸ‡¯ğŸ‡µ Japan (143462-1,32)</option>
                <option value="143466-1,32">ğŸ‡°ğŸ‡· Korea (143466-1,32)</option>
                <option value="143464-1,32"
                  >ğŸ‡¸ğŸ‡¬ Singapore (143464-1,32)</option
                >
                <option value="custom">Tá»± nháº­p Storefrontâ€¦</option>
              </select>
            </div>
            <div class="helper-text">
              Chá»n quá»‘c gia trÃ¹ng vá»›i vÃ¹ng Apple ID. Náº¿u khÃ´ng cháº¯c, Ä‘á»ƒ
              <strong>Tá»± Ä‘á»™ng</strong>.
            </div>
          </div>
        </div>

        <div class="field" id="storefront-custom-wrap" style="display: none">
          <label for="STOREFRONT">Storefront tÃ¹y chá»‰nh</label>
          <input
            id="STOREFRONT"
            placeholder="VÃ­ dá»¥: 143471-1,32"
            autocomplete="off"
          />
          <div class="helper-text">
            Chá»‰ cáº§n náº¿u muá»‘n Ã©p má»™t mÃ£ storefront cá»¥ thá»ƒ (server hiá»‡n chÆ°a dÃ¹ng,
            chá»§ yáº¿u Ä‘á»ƒ báº¡n note).
          </div>
        </div>

        <div class="field">
          <label for="INPUT">Bundle ID hoáº·c link App Store</label>
          <input
            id="INPUT"
            placeholder="vd: mobi.MultiCraft hoáº·c https://apps.apple.com/.../id1174039276"
            required
          />
        </div>

        <div style="display: flex; justify-content: space-between; gap: 8px">
          <button type="submit" id="submitBtn">
            <span class="btn-label">
              <span id="btnIcon">â•</span>
              <span id="btnText">ThÃªm vÃ o ÄÃ£ mua</span>
            </span>
          </button>
          <div class="helper-text" style="align-self: center; text-align: right">
            âš ï¸ Chá»‰ dÃ¹ng vá»›i <strong>Apple ID phá»¥ cá»§a báº¡n</strong>. KhÃ´ng nháº­p
            tÃ i khoáº£n cá»§a ngÆ°á»i khÃ¡c.
          </div>
        </div>
      </form>

      <div id="status" class="status">
        <div class="status-icon" id="statusIcon">â„¹ï¸</div>
        <div class="status-text" id="statusText"></div>
        <div class="status-code" id="statusCode"></div>
      </div>

      <div class="output-wrap">
        <pre id="out">ChÆ°a cÃ³ request nÃ o Ä‘Æ°á»£c gá»­i.</pre>
      </div>
    </main>

    <script>
      const $ = (s) => document.querySelector(s);

      const statusEl = $('#status');
      const statusIconEl = $('#statusIcon');
      const statusTextEl = $('#statusText');
      const statusCodeEl = $('#statusCode');
      const outEl = $('#out');
      const form = $('#f');
      const submitBtn = $('#submitBtn');
      const btnIcon = $('#btnIcon');
      const btnText = $('#btnText');
      const storefrontSelect = $('#STOREFRONT_SELECT');
      const storefrontCustomWrap = $('#storefront-custom-wrap');
      const storefrontInput = $('#STOREFRONT');

      function setStatus(type, text, code) {
        statusEl.className = 'status';
        if (!type) {
          statusEl.style.display = 'none';
          return;
        }
        statusEl.style.display = 'flex';
        if (type === 'info') {
          statusEl.classList.add('status--info');
          statusIconEl.textContent = 'â„¹ï¸';
        } else if (type === 'success') {
          statusEl.classList.add('status--success');
          statusIconEl.textContent = 'âœ…';
        } else if (type === 'error') {
          statusEl.classList.add('status--error');
          statusIconEl.textContent = 'âš ï¸';
        }
        statusTextEl.textContent = text || '';
        statusCodeEl.textContent = code ? `(${code})` : '';
      }

      storefrontSelect.addEventListener('change', () => {
        if (storefrontSelect.value === 'custom') {
          storefrontCustomWrap.style.display = 'block';
          storefrontInput.focus();
        } else {
          storefrontCustomWrap.style.display = 'none';
          storefrontInput.value = '';
        }
      });

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        setStatus('info', 'Äang xá»­ lÃ½ yÃªu cáº§uâ€¦', '');
        outEl.textContent = 'Äang gá»i API /purchaseâ€¦';

        const storefrontSelectVal = storefrontSelect.value;
        const storefrontFinal =
          storefrontSelectVal === 'custom'
            ? storefrontInput.value.trim() || undefined
            : storefrontSelectVal || undefined;

        const body = {
          APPLE_ID: $('#APPLE_ID').value.trim(),
          PASSWORD: $('#PASSWORD').value,
          CODE: $('#CODE').value.trim() || undefined,
          input: $('#INPUT').value.trim(),
          storefront: storefrontFinal,
        };

        submitBtn.disabled = true;
        btnIcon.textContent = 'â³';
        btnText.textContent = 'Äang thá»±c hiá»‡nâ€¦';

        try {
          const r = await fetch('/purchase', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body),
          });

          const data = await r.json().catch(() => ({}));

          if (data.require2FA) {
            setStatus(
              'info',
              'Apple yÃªu cáº§u mÃ£ 2FA. Nháº­p mÃ£ vÃ o Ã´ "MÃ£ 2FA" rá»“i báº¥m láº¡i.',
              ''
            );
            outEl.textContent = JSON.stringify(data, null, 2);
          } else if (data.success) {
            const msg =
              data.message ||
              data.customerMessage ||
              'ÄÃ£ thÃªm vÃ o ÄÃ£ mua (theo ipatool).';
            setStatus('success', msg, '');
            outEl.textContent = JSON.stringify(data, null, 2);
          } else {
            const msg =
              data.error ||
              data.customerMessage ||
              'KhÃ´ng thá»ƒ thÃªm vÃ o má»¥c ÄÃ£ mua.';
            setStatus(
              'error',
              msg,
              data.failureType || data.failureCode || data.step || ''
            );
            outEl.textContent = JSON.stringify(data, null, 2);
          }
        } catch (err) {
          setStatus(
            'error',
            'Lá»—i máº¡ng hoáº·c server. Xem console Ä‘á»ƒ biáº¿t thÃªm chi tiáº¿t.',
            ''
          );
          outEl.textContent = String(err);
        } finally {
          submitBtn.disabled = false;
          btnIcon.textContent = 'â•';
          btnText.textContent = 'ThÃªm vÃ o ÄÃ£ mua';
        }
      });
    </script>
  </body>
</html>